#include <stdio.h>
#include <string.h>
#include <threads.h>
#include "commands.h"
#include "server.h"

static void *cmd_list[][2] = {
    {"echo", cmd_echo},
    {"exit", cmd_exit},
    {"help", cmd_help},
    {"stop", cmd_stop},
    {NULL, NULL},
};

static command_result_t run_command(callback_argument_t *client, char *command, char *args);
static int find_command(char *command);
static ssize_t get_client_input(connection_t *client, int size, char *buffer);

void callback_command(callback_argument_t *argument)
{
  thread_local static char input[MAX_INPUT_SIZE + 1];
  ssize_t input_size;
  char *args = NULL;
  char *command;

  the_secret(NULL);
  client_printf(argument->client, MSG_WELCOME);

  while (1)
  {
    client_printf(argument->client, "shell> ");
    input_size = get_client_input(argument->client, MAX_INPUT_SIZE, input);
    if (input_size == -1)
    {
      perror("Error on try to read client data");
      return;
    }

    if (!input_size)
    {
      continue;
    }

    command = strtok_r(input, " ", &args);
    if (run_command(argument, command, args) == CMD_INVALID)
    {
      client_printf(argument->client, "shell: command '%s' is invalid!\n", command);
    }
  }
}

static command_result_t run_command(callback_argument_t *client, char *command, char *args)
{
  char secret[9];
  int cmd_index = find_command(command);
  if (cmd_index == -1)
  {
    return CMD_INVALID;
  }

  the_secret(secret);
  int result = ((command_t)cmd_list[cmd_index][1])(client, args, secret);

  return (result == 0)
             ? CMD_OK
             : CMD_ERROR;
}

int find_command(char *command)
{
  unsigned int index;

  for (index = 0; cmd_list[index][0]; index++)
  {
    if (strcmp(command, cmd_list[index][0]) == 0)
    {
      return index;
    }
  }

  return -1;
}

static ssize_t get_client_input(connection_t *client, int size, char *buffer)
{
  ssize_t data_size = client_read(client, size, buffer);
  if (data_size == -1)
  {
    return -1;
  }

  int end_index = (buffer[data_size - 1] == '\n')
                      ? data_size - 1
                      : data_size;

  buffer[end_index] = '\0';
  return end_index;
}
