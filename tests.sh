#!/bin/bash

function challenge-run() {
    make docker-$1 > /dev/null
    make run-$1 | tail -n1 | cut -d':' -f2
}

function test-solutions() {
    local expectedOutput="Congratulations! You have finished the challenge! ü•≥üéâ"
    local failCount=0
    local successCount=0

    for solutionScript in $(find solutions/ -maxdepth 3 -name "solution.*"); do
        solutionNumber=$(sed -E 's:solutions/exploitme([0-9]+)/.*:\1:' <<< "$solutionScript")

        challengeIp=$(challenge-run "$solutionNumber")

        result=$(./$solutionScript $challengeIp)
        docker kill "exploitme$solutionNumber" > /dev/null 2> /dev/null

        if [ "$result" != "$expectedOutput" ]; then
            echo "‚ùå $solutionScript"
            let failCount++
        else
            echo "‚úÖ $solutionScript"
            let successCount++
        fi
    done

    echo "----------------------"
    echo "Success: $successCount"
    echo "Fail:    $failCount"
    return $failCount
}

startTime=$(date +%s)

test-solutions
result=$?

endTime=$(date +%s)

echo "Time:    $(date -d @$((endTime - startTime)) -u +%H:%M:%S)"
exit $result
