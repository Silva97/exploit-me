#include <stdlib.h>
#include <threads.h>
#include <stdio.h>
#include "server.h"

static int call_callback(callback_argument_t *argument);

int server_accept(connection_t *server, server_callback_t callback)
{
  socklen_t addrlen = sizeof(struct sockaddr_in);
  connection_t *client = malloc(sizeof(connection_t));
  if (!client)
  {
    return -1;
  }

  client->socket = accept(server->socket,
                          (struct sockaddr *)&client->address,
                          &addrlen);
  if (client->socket == -1)
  {
    return -1;
  }

  callback_argument_t *argument = malloc(sizeof(callback_argument_t));
  if (!argument)
  {
    return -1;
  }

  argument->_callback = callback;
  argument->client = client;
  argument->server = server;

  thrd_t new_thread;
  int result = thrd_create(&new_thread, (thrd_start_t)call_callback, argument);
  return (result != thrd_success)
             ? -1
             : 0;
}

static int call_callback(callback_argument_t *argument)
{
  argument->_callback(argument);

  close(argument->client->socket);
  free(argument->client);
  free(argument);

  return 0;
}
