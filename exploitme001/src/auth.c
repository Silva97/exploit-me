#include <threads.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "auth.h"
#include "utils.h"

#define INPUT_SIZE 32

thread_local static auth_config_t *config;

static void check_credential(callback_argument_t *argument);
static int make_credential(user_t **credential, char *login, char *password);
static ssize_t get_client_input(connection_t *client, int size, char *buffer);

void auth_init(void)
{
  config = malloc(sizeof(auth_config_t));
  config->enable_password = 1;

  strcpy(config->credentials.login, "admin");
  random_string(config->credentials.password, 16);
}

void callback_auth(callback_argument_t *argument)
{
  char *client_ip = inet_ntoa(argument->client->address.sin_addr);
  printf("Connection from: %s\n", client_ip);

  auth_init();
  check_credential(argument);
}

static void check_credential(callback_argument_t *argument)
{
  user_t *credential;
  char login[INPUT_SIZE + 1];
  char password[INPUT_SIZE + 1];
  thread_local static unsigned short int attempt = 0;

  if (attempt++ >= 3)
  {
    client_printf(argument->client, "Maximum attempts exceeded!\n");
    return;
  }

  client_printf(argument->client, "Login: ");
  if (get_client_input(argument->client, INPUT_SIZE, login) == -1)
  {
    return;
  }

  client_printf(argument->client, "Password: ");
  if (get_client_input(argument->client, INPUT_SIZE, password) == -1)
  {
    return;
  }

  printf("* Trying to auth with %s:%s ...\n", login, password);
  if (!make_credential(&credential, login, password))
  {
    client_printf(argument->client, "Attempt %d failed!\n", attempt);

    if (attempt == 1)
    {
      free(config);
    }
    check_credential(argument);
    return;
  }

  printf("* Login successful! Sending flag: %s\n", EME_CHALLENGE_FLAG);
  client_printf(argument->client, EME_CHALLENGE_FLAG);
}

static int make_credential(user_t **credential, char *login, char *password)
{
  *credential = malloc(sizeof(user_t));
  user_t *auth = *credential;

  strcpy(auth->login, login);
  strcpy(auth->password, password);

  if (config->enable_password == -1)
  {
    return strcmp(auth->login, login) == 0;
  }

  return memcmp(&config->credentials, auth, sizeof(user_t)) == 0;
}

static ssize_t get_client_input(connection_t *client, int size, char *buffer)
{
  ssize_t data_size = client_read(client, size, buffer);
  if (data_size == -1)
  {
    perror("Error on try to read client data");
    return -1;
  }

  int end_index = (buffer[data_size - 1] == '\n')
                      ? data_size - 1
                      : data_size;

  buffer[end_index] = '\0';
  return end_index;
}
