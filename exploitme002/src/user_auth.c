#include <stdint.h>
#include <string.h>
#include <threads.h>
#include "messages.h"
#include "user_auth.h"
#include "utils.h"

thread_local static credentials_t auth = {
    .login = "admin",
};

void callback_auth(callback_argument_t *argument)
{
  uint8_t login_size;
  uint8_t password_size;

  CLIENT_READ_OR_RETURN(argument->client, sizeof(uint8_t), &login_size);
  char login[login_size];
  CLIENT_READ_OR_RETURN(argument->client, login_size, login);
  login[login_size] = '\0';

  if (strncmp(login, auth.login, login_size) != 0)
  {
    client_send(argument->client, sizeof MSG_WRONG_LOGIN_PREFIX, MSG_WRONG_LOGIN_PREFIX);
    client_send(argument->client, login_size, login);
    client_send(argument->client, sizeof MSG_WRONG_LOGIN_SUFFIX, MSG_WRONG_LOGIN_SUFFIX);
    return;
  }

  CLIENT_READ_OR_RETURN(argument->client, sizeof(uint8_t), &password_size);
  char password[password_size];
  CLIENT_READ_OR_RETURN(argument->client, password_size, password);
  password[password_size] = '\0';

  if (strncmp(password, auth.password, password_size) != 0)
  {
    client_send(argument->client, sizeof MSG_WRONG_PASSWORD_PREFIX, MSG_WRONG_PASSWORD_PREFIX);
    client_send(argument->client, login_size, auth.login);
    client_send(argument->client, sizeof MSG_WRONG_PASSWORD_SUFFIX, MSG_WRONG_PASSWORD_SUFFIX);
    return;
  }

  client_printf(argument->client, MSG_CHALLENGE_FINISHED);
}

void auth_init(void)
{
  random_string(auth.password, 16);
}
