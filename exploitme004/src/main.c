#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include "server.h"

connection_t server;

void stop_handler(int signum);
void callback_auth(callback_argument_t *argument);

int main(void)
{
  struct sigaction stop_action = {
      .sa_handler = stop_handler,
  };

  if (server_create(&server, 1337) == -1)
  {
    perror("Error on try to init server");
    return EXIT_FAILURE;
  }

  sigaction(SIGSTOP, &stop_action, NULL);
  sigaction(SIGINT, &stop_action, NULL);
  puts("Listening on port 1337 ...");

  while (1)
  {
    if (server_accept(&server, callback_auth) == -1)
    {
      perror("Error on try to connect to client");
      return EXIT_FAILURE;
    }
  }

  return EXIT_SUCCESS;
}

void stop_handler(int signum)
{
  puts("Stopping server ...");
  server_stop(&server);

  _Exit(EXIT_SUCCESS);
}
